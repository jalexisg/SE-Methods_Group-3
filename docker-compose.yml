services:
  database:
    image: mysql:8.0
    container_name: database
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: example
      MYSQL_DATABASE: world
      MYSQL_USER: app
      MYSQL_PASSWORD: apppass
    ports:
      - "33061:3306"   # map host port 33060 to container 3306 so host processes can connect
    volumes:
      - ./database/world.sql:/docker-entrypoint-initdb.d/world.sql
      - mysql_data:/var/lib/mysql
    healthcheck:
      # Use the service name for host; mysqladmin will connect to the local server inside the container
      test: ["CMD-SHELL", "mysqladmin ping -h database -pexample --silent || mysqladmin ping -h 127.0.0.1 -pexample --silent"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks:
      - population-network

  app:
    build:
      context: .
    container_name: population-app
    depends_on:
      database:
        condition: service_healthy
    environment:
      JAVA_OPTS: -Xmx512m -Xms256m
      DB_HOST: mysql
      DB_NAME: world
      DB_USER: app
      DB_PASSWORD: apppass
      # Provide the TEST_* environment variables that `Main` checks for test/runtime DB overrides
      TEST_DB_URL: 'jdbc:mysql://database:3306/world?allowPublicKeyRetrieval=true&useSSL=false'
      TEST_DB_USER: 'app'
      TEST_DB_PASSWORD: 'apppass'
    # Adjust the command to how your jar accepts configuration;
    # here we pass the DB host via an environment variable.
    # Escape the $ so docker-compose does not interpolate it at compose-time; the shell
    # inside the container will expand $JAVA_OPTS at runtime. This prevents the
    # "variable is not set" warning on the client.
    command: ["sh", "-c", "java $$JAVA_OPTS -jar app.jar"]
    # Mount host reports so files written by the app are visible to the nginx service.
    volumes:
      - ./reports:/app/reports
      - ./tmp/reports:/tmp/reports
    # Use root so the container can write to the host-mounted directory without extra UID mapping.
    # You can remove this after verifying generation and fixing ownership (chown) on the host.
    user: root
    networks:
      - population-network

  nginx:
    image: nginx:stable-alpine
    container_name: reports-nginx
    restart: unless-stopped
    depends_on:
      - app
    ports:
      - "8081:80"
    volumes:
      - ./reports:/usr/share/nginx/html:ro
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - population-network

networks:
  population-network:
    driver: bridge

volumes:
  mysql_data:
